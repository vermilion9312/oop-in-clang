/*
 * app_main.c
 *
 *  Created on: Sep 23, 2025
 *      Author: vermi
 */


#include <app_main.h>
#include <main.h>
#include <input.h>
#include <output.h>
#include <segment.h>

extern TIM_HandleTypeDef htim6;

typedef enum {
	CLOCK,
	TIMER,
	STOPWATCH,
	ALARM,
	MUSIC_PLAYER
} Mode;

typedef enum {
	STOPPED,
	PAUSED,
	RUNNING
} State;

static Mode  mode  = STOPWATCH;
static State state = STOPPED;

void operation_clock(void);
void operate_stopwatch(void);

void app_init(void)
{
	HAL_TIM_Base_Start_IT(&htim6);
	_7SEG_GPIO_Init();
}

void app_loop(void)
{
	update(BUTTON_1);
	update(BUTTON_2);
	update(BUTTON_3);

	if(is_pressed(BUTTON_1)) toggle(LEFT_RED);
	if(is_pressed(BUTTON_2)) toggle(LEFT_GREEN);
	if(is_pressed(BUTTON_3)) toggle(LEFT_BLUE);

	if(is_released(BUTTON_1)) toggle(RIGHT_RED);
	if(is_released(BUTTON_2)) toggle(RIGHT_GREEN);
	if(is_released(BUTTON_3)) toggle(RIGHT_BLUE);

	if(is_pressed(BUTTON_1)) set_time_zero();

	operate_segment(is_held(BUTTON_1));

	switch (mode)
	{
	case CLOCK:
		return;
	case TIMER:
		return;
	case STOPWATCH:
		operate_stopwatch();
		return;
	case ALARM:
		return;
	case MUSIC_PLAYER:
		return;
	default:
		return;
	}
}

void operate_stopwatch(void)
{
	switch (state)
	{
	case STOPPED:
		if (is_released(BUTTON_2)) state = RUNNING;
		return;
	case RUNNING:
		if (is_released(BUTTON_2)) state = PAUSED;
		return;
	case PAUSED:
		if (is_released(BUTTON_2)) state = RUNNING;
		if (is_released(BUTTON_3)) state = STOPPED;
		return;
	default:
		return;
	}
}

void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{
	if (htim->Instance == TIM6)
	{
		if(is_held(BUTTON_1)) increase_time();

		switch (state)
		{
		case STOPPED:
			set_time_zero();
			return;
		case RUNNING:
			increase_time();
			return;
		case PAUSED:
			return;
		default:
			return;
		}

	}
}
