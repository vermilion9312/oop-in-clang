/*
 * input.c
 *
 *  Created on: Sep 23, 2025
 *      Author: vermi
 */


#include <input.h>


static bool is_held(Input* public)
{
	THIS(Input, public);
	return this->state;
}

static bool is_pressed(Input* public)
{
	THIS(Input, public);
	return !this->last_state && this->state;
}

static bool is_released(Input* public)
{
	THIS(Input, public);
	return this->last_state && !this->state;
}

static void tick(Input* public)
{
	THIS(Input, public);
	Callback callback = this->callback;
	InputEvent event  = this->event;

	this->last_state = this->state;
	this->state = HAL_GPIO_ReadPin(this->port, this->pin);

//	if (!callback || !callback.fuction || !callback.context) return;

	switch(event)
	{
	case HELD:
		if (is_held(public)) callback.fuction(callback.context);
		return;
	case NOT_HELD:
		if (!is_held(public)) callback.fuction(callback.context);
		return;
	case PRESSED:
		if (is_pressed(public)) callback.fuction(callback.context);
		return;
	case RELEASED:
		if (is_released(public)) callback.fuction(callback.context);
		return;
	default:
		return;
	}
}

void set_callback(Input* public, void* context, CallbackFunction function, InputEvent event)
{
	THIS(Input, public);
	this->callback.context = context;
	this->callback.fuction = function;
	this->event = event;
}

Input* new_Input(GPIO_TypeDef* port, uint16_t pin)
{
	InputPrivate* this = calloc(sizeof(InputPrivate), 1);

	this->public.tick = tick;
	this->public.set_callback = set_callback;

	this->port = port;
	this->pin  = pin;

	return (Input*) this;
}
